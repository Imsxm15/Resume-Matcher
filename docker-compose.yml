services:
  backend:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
    restart: always
    environment:
      # --- Configuration OpenAI Forcée ---
      - LLM_PROVIDER=openai
      - EMBEDDING_PROVIDER=openai
      - LL_MODEL=gpt-4o-mini
      - EMBEDDING_MODEL=text-embedding-3-small
      # --- Clés API (Injectées par Hostinger ou .env) ---
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LLM_API_KEY=${OPENAI_API_KEY}
      - EMBEDDING_API_KEY=${OPENAI_API_KEY}
      # --- Base de données ---
      - SYNC_DATABASE_URL=sqlite:////data/app.db
      - ASYNC_DATABASE_URL=sqlite+aiosqlite:////data/app.db
      - SESSION_SECRET_KEY=${SESSION_SECRET_KEY:-insecure_secret_change_me}
    volumes:
      - backend_data:/data
    ports:
      - "8000:8000"

  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
      args:
        # IMPORTANT : C'est ici qu'on dit au frontend où est le backend
        # Remplace par l'IP de ton VPS si tu n'utilises pas localhost
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8000}
    restart: always
    ports:
      - "3000:3000"
    environment:
      # URL pour les appels serveur interne (Server Side Rendering)
      - NEXT_PUBLIC_API_URL=http://backend:8000
    depends_on:
      - backend

volumes:
  backend_data:
