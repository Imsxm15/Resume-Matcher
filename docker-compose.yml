version: '3.8'

services:
  backend:
    build: ./apps/backend
    container_name: resume_matcher_backend
    restart: unless-stopped
    environment:
      # Configuration Base de données (Persistance)
      - SYNC_DATABASE_URL=sqlite:////data/app.db
      - ASYNC_DATABASE_URL=sqlite+aiosqlite:////data/app.db
      
      # Configuration OpenAI (Variables critiques)
      - LLM_PROVIDER=openai
      - EMBEDDING_PROVIDER=openai
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Modèles choisis (ajustables selon tes préférences/coûts)
      - LL_MODEL=gpt-4o-mini
      - EMBEDDING_MODEL=text-embedding-3-small
      
      # Sécurité
      - SESSION_SECRET_KEY=${SESSION_SECRET_KEY}
    volumes:
      # Persistance de la base de données SQLite
      - ./docker-data/db:/data
    networks:
      - app-network

  frontend:
    build:
      context: ./apps/frontend
      args:
        # Configuration de l'URL publique (Ton IP Hostinger)
        - NEXT_PUBLIC_API_URL=http://31.97.176.215
    container_name: resume_matcher_frontend
    restart: unless-stopped
    networks:
      - app-network

  nginx:
    image: nginx:alpine
    container_name: resume_matcher_nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend
      - frontend
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
